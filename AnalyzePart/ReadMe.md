
# このプログラムについて
Line bot(ユーザーが入力する)から、  
会社名(仮想通貨名)と文章が送られてくるので、  
このプログラムの中でユーザーが相談してきたものがマルチ商法かどうかを検出する。  
説明(どの部分が判断の根拠になったかなど)も返せるようにしたい。  
このプログラムでは使用対象のクラスを

# 環境について
下記の環境整備のため、pythonのバージョン変更、およびライブラリのインストール(pip install)を行ってください。  
(推奨:使用ライブラリが少ないので、適当にインストールしても動くと思われますが一応。)  
```
Python==3.8.5  
beautifulsoup4==4.9.3  
requests==2.25.1  
その他、csv、json
```
別件：
yahooのAPIを取得して下さい。  
1: yahooアカウントを取得。(※携帯電話必須)  
2: デベロッパーのページでAPIキーをコピーしてAPIKey.txtに保存する。  

# 使い方
1:ライブラリのインストール  
```
pip install beautifulsoup4==4.9.3  
pip install requests==2.25.1
```
2: yahooのAPIを取得して、APIKey.txtに保存する。  
※改行などを入れないこと。

3:Keyword.txtにキーワードと重みを書く。  

4:(サーバー上などで)実行する。  
リクエストが来たら、プログラムに投げて出力結果を利用する。
(プログラムとしての使用は下記を参照。)

# プログラムとしての使い方
このプログラムのユーザーは、conductor.py(特に、その中のクラスanalyzeConductor)を使用すれば良いです。  
conductor.pyの処理部分(if \_\_name\_\_ == "\_\_main\_\_":で始まる部分。)に実行例を記載しています。

```

conductor = analyzeConductor(is_only_score=True)
userText = "○○○集団のマルチ商法には気を付けよう！"
result = conductor.InTheCaseOfUsertextParse(userText)
print(result)
```

1:analyzeConductorクラスをインスタンス化する。  
2: 1で作成したインスタンスのメソッドを使用して、分析を行う。
```
    singleQueryAndAnalyzeForSpecificPhrase : ユーザーが会社名などを送ってきた際に使用します。ユーザーが既にキーワード抽出していることと等価なので、yahooのAPIを使用せずに分析を行います。google検索のトップ10、ニューストップ10を分析し、対象となる単語("逮捕"、"容疑者"など)が含まれていないかを調べ、重みによってscore化します。出力形式は、「使用方法」に記載してあります。  
    
    multiQueryAndAnalyze：ユーザーが文章を丸々送って来た際に使用します。中でyahooAPIを使用し、google検索のトップ10、ニューストップ10を分析し、対象となる単語("逮捕"、"容疑者"など)が含まれていないかを調べ、重みによってscore化します。出力形式は、「使用方法」に記載してあります。 

```
# 使用方法
1つのキーワードに対して、返ってくる結果は下記のような結果です。
```
{   
    "keyword" : userSpecificPhrase,
    "google_top_10_result" : 
        {
            "result" : NewsResult,
            "score"  : scoreByNews
        },
    "google_news_result" : 
        {
            "result" : TopPageResult,
            "score"  : scoreByTopPage
        }
}
```
上記は、analyzeConductorクラスのsingleQueryAndAnalyzeメソッドの結果です。

このツールでは文章であれば、yahooキーワード抽出の結果上位3件、
ユーザーが個別にキーワードを指定する場合(会社名など)では、
キー:keywordを変えて、specific_keywordとして上記のjsonを返します。
(jsondumpはしていません。)
したがって、上記の例のJSONが複数リストとして返ってきます。

# プログラムの説明

## yahooKeyPhraseExtraction.py
文章について、キーワードを抽出して返す。  
キーワードと、重要度も返す。重要度を見て再検索プログラムで検出を行う。  
※外部ユーザー(サーバー上でこのプログラムを使用する人)の使用は想定していません。

## 再検索による分析ツール
google~となっているpythonプログラムが該当します。  
現在は「キーワードが"ニュースなどの部分"に含まれているかどうか」を調べています。  
※外部ユーザー(サーバー上でこのプログラムを使用する人)の使用は想定していません。

## その他
内部で使われている関数です。  
fileUtils.pyなどが該当します。  
※外部ユーザー(サーバー上でこのプログラムを使用する人)の使用は想定していません。


# 注意点
※ 中でスクレイピングしています。従って、このプログラムを短時間で何度も実行することは避けてください。  
(場合によってはDDos攻撃となります。)  
目安としては、1キーワード(~株式会社など)で2クエリを行っています。  
※ ライセンスは一応MITとします。(中で使用されているライブラリのライセンスに依存しますが。)

# スコアについて
スコアは下記の数式に基づいて算出されます。


$$ \sum_{k \in キーワード全て} \frac{weight(k)}{キーワードすべての重み} × \frac{1}{記事数} $$

$weight(k)$はキーワードkの重みを表します。

```
例：
キーワード検索→記事3コの場合
記事1 : A, C
記事2 : B
記事3 : C
keyword.txt(A,B,C)
A : 50→ 50/(50+30+10)
B : 30→ 30/(50+30+10)
C : 10→ 10/(50+30+10)
各記事に対して重みの合計を求めて、全体の重みを求める。
1/3 × (50/90+ 10/90) + 1/3 × (30/90) + 1/3 × (10/90) = 100 /270
```

# 改善方法  
改善を図りたい場合、Keyword.txtを変更すると改善の可能性があります。  
Keyword.txtは下記のように、含まれていないか調べたいキーワード、重みをcsv形式で渡します。  
Keyword.txt
```
マルチ商法  ,100
逮捕        ,80
犯罪        ,80
容疑者      ,80
勧誘        ,80
```
上記のファイルの単語を増やしたり、重みを正しくすることで良い精度が得られるかもしれません。
